apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: zionet-apps-featest
  namespace: argocd
  annotations:
    # Enable image updater for multiple images
    argocd-image-updater.argoproj.io/image-list: >-
      manager=teachindevacr.azurecr.io/manager,
      learning-manager=teachindevacr.azurecr.io/learning-manager,
      accessor=teachindevacr.azurecr.io/accessor,
      storage-accessor=teachindevacr.azurecr.io/storage-accessor,
      database-accessor=teachindevacr.azurecr.io/database-accessor,
      engine=teachindevacr.azurecr.io/engine,
      ai-engine=teachindevacr.azurecr.io/ai-engine
    
    # Update strategy for each image (newest-build, semver, etc.)
    argocd-image-updater.argoproj.io/manager.update-strategy: newest-build
    argocd-image-updater.argoproj.io/learning-manager.update-strategy: newest-build
    argocd-image-updater.argoproj.io/accessor.update-strategy: newest-build
    argocd-image-updater.argoproj.io/storage-accessor.update-strategy: newest-build
    argocd-image-updater.argoproj.io/database-accessor.update-strategy: newest-build
    argocd-image-updater.argoproj.io/engine.update-strategy: newest-build
    argocd-image-updater.argoproj.io/ai-engine.update-strategy: newest-build
    
    # Helm parameter paths - tell image updater which Helm values to update
    argocd-image-updater.argoproj.io/manager.helm.image-name: manager.image.repository
    argocd-image-updater.argoproj.io/manager.helm.image-tag: manager.image.tag
    argocd-image-updater.argoproj.io/learning-manager.helm.image-name: learningManager.image.repository
    argocd-image-updater.argoproj.io/learning-manager.helm.image-tag: learningManager.image.tag
    argocd-image-updater.argoproj.io/accessor.helm.image-name: accessor.image.repository
    argocd-image-updater.argoproj.io/accessor.helm.image-tag: accessor.image.tag
    argocd-image-updater.argoproj.io/storage-accessor.helm.image-name: storageAccessor.image.repository
    argocd-image-updater.argoproj.io/storage-accessor.helm.image-tag: storageAccessor.image.tag
    argocd-image-updater.argoproj.io/database-accessor.helm.image-name: databaseAccessor.image.repository
    argocd-image-updater.argoproj.io/database-accessor.helm.image-tag: databaseAccessor.image.tag
    argocd-image-updater.argoproj.io/engine.helm.image-name: engine.image.repository
    argocd-image-updater.argoproj.io/engine.helm.image-tag: engine.image.tag
    argocd-image-updater.argoproj.io/ai-engine.helm.image-name: aiEngine.image.repository
    argocd-image-updater.argoproj.io/ai-engine.helm.image-tag: aiEngine.image.tag
    
    # Allow tags - only tags matching the environment
    argocd-image-updater.argoproj.io/manager.allow-tags: "featest"
    argocd-image-updater.argoproj.io/learning-manager.allow-tags: "featest"
    argocd-image-updater.argoproj.io/accessor.allow-tags: "featest"
    argocd-image-updater.argoproj.io/storage-accessor.allow-tags: "featest"
    argocd-image-updater.argoproj.io/database-accessor.allow-tags: "featest"
    argocd-image-updater.argoproj.io/engine.allow-tags: "featest"
    argocd-image-updater.argoproj.io/ai-engine.allow-tags: "featest"

    # Write back method - use 'argocd' for parameter override or 'git' to commit changes
    argocd-image-updater.argoproj.io/write-back-method: argocd
    
    # Optional: Force update even if image already exists
    argocd-image-updater.argoproj.io/manager.force-update: "true"
    argocd-image-updater.argoproj.io/learning-manager.force-update: "true"
    argocd-image-updater.argoproj.io/accessor.force-update: "true"
    argocd-image-updater.argoproj.io/storage-accessor.force-update: "true"
    argocd-image-updater.argoproj.io/database-accessor.force-update: "true"
    argocd-image-updater.argoproj.io/engine.force-update: "true"
    argocd-image-updater.argoproj.io/ai-engine.force-update: "true"
    
    # Optional: Pull secret for private registry (using docker-registry format)
    argocd-image-updater.argoproj.io/manager.pull-secret: pullsecret:argocd/acr-credentials
    argocd-image-updater.argoproj.io/learning-manager.pull-secret: pullsecret:argocd/acr-credentials
    argocd-image-updater.argoproj.io/accessor.pull-secret: pullsecret:argocd/acr-credentials
    argocd-image-updater.argoproj.io/storage-accessor.pull-secret: pullsecret:argocd/acr-credentials
    argocd-image-updater.argoproj.io/database-accessor.pull-secret: pullsecret:argocd/acr-credentials
    argocd-image-updater.argoproj.io/engine.pull-secret: pullsecret:argocd/acr-credentials
    argocd-image-updater.argoproj.io/ai-engine.pull-secret: pullsecret:argocd/acr-credentials
spec:
  project: default
  source:
    repoURL: 'https://github.com/ZionetLearning/learning-teachin-zionet.git'
    targetRevision: avichai/1117/deploying-new-services
    path: devops/kubernetes/charts
    helm:
      valueFiles:
        - values.yaml
        - values.template.yaml
      parameters:
      - name: global.namePrefix
        value: featest
      - name: namespace.name
        value: featest
      - name: global.dockerRegistry
        value: teachindevacr.azurecr.io
      - name: global.environment
        value: featest
      - name: dapr.stateStore.redis.redisDB
        value: "3"
      - name: keda.enabled
        value: "true"
      - name: langfuse.enabled
        value: "false"
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: featest
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true