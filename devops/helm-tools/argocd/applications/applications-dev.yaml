apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: zionet-apps-dev
  namespace: argocd
  annotations:
    # Enable image updater for multiple images
    argocd-image-updater.argoproj.io/image-list: >-
      manager=teachindevacr.azurecr.io/manager,
      accessor=teachindevacr.azurecr.io/accessor,
      engine=teachindevacr.azurecr.io/engine
    
    # Update strategy for each image (newest-build, semver, etc.)
    argocd-image-updater.argoproj.io/manager.update-strategy: newest-build
    argocd-image-updater.argoproj.io/accessor.update-strategy: newest-build
    argocd-image-updater.argoproj.io/engine.update-strategy: newest-build
    
    # Helm parameter paths - tell image updater which Helm values to update
    argocd-image-updater.argoproj.io/manager.helm.image-name: manager.image.repository
    argocd-image-updater.argoproj.io/manager.helm.image-tag: manager.image.tag
    argocd-image-updater.argoproj.io/accessor.helm.image-name: accessor.image.repository
    argocd-image-updater.argoproj.io/accessor.helm.image-tag: accessor.image.tag
    argocd-image-updater.argoproj.io/engine.helm.image-name: engine.image.repository
    argocd-image-updater.argoproj.io/engine.helm.image-tag: engine.image.tag
    
    # Allow tags - only tags matching the environment
    argocd-image-updater.argoproj.io/manager.allow-tags: "dev"
    argocd-image-updater.argoproj.io/accessor.allow-tags: "dev"
    argocd-image-updater.argoproj.io/engine.allow-tags: "dev"

    # Write back method - use 'argocd' for parameter override or 'git' to commit changes
    argocd-image-updater.argoproj.io/write-back-method: argocd
    
    # Optional: Force update even if image already exists
    argocd-image-updater.argoproj.io/manager.force-update: "true"
    argocd-image-updater.argoproj.io/accessor.force-update: "true"
    argocd-image-updater.argoproj.io/engine.force-update: "true"
    
    # Optional: Pull secret for private registry (using docker-registry format)
    argocd-image-updater.argoproj.io/manager.pull-secret: pullsecret:argocd/acr-credentials
    argocd-image-updater.argoproj.io/accessor.pull-secret: pullsecret:argocd/acr-credentials
    argocd-image-updater.argoproj.io/engine.pull-secret: pullsecret:argocd/acr-credentials
spec:
  project: default
  source:
    repoURL: 'https://github.com/ZionetLearning/learning-teachin-zionet.git'
    targetRevision: main
    path: devops/kubernetes/charts
    helm:
      valueFiles:
        - values.yaml
        - values.dev.yaml
      parameters:
      - name: global.namePrefix
        value: dev
      - name: global.dockerRegistry
        value: teachindevacr.azurecr.io
      - name: global.environment
        value: dev
      - name: dapr.stateStore.redis.redisDB
        value: "0"
      - name: keda.enabled
        value: "true"
      - name: langfuse.enabled
        value: "true"
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: dev
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true