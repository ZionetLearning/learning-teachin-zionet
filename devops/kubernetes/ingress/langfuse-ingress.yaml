# Langfuse root auth routes ingress (handle redirects from NextAuth)
# This file is a template - use langfuse.sh to deploy with correct environment settings
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: langfuse-auth-ingress
  namespace: devops-tools
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/priority: "300"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - DOMAIN_PLACEHOLDER
      secretName: DOMAIN_SECRET_PLACEHOLDER
  rules:
  - host: DOMAIN_PLACEHOLDER
    http:
      paths:
      # API routes at root level (NextJS app makes calls here when served under /langfuse)
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      # Static assets at root level (icon.svg, favicon.ico, etc.)
      - path: /icon.svg
        pathType: Exact
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      - path: /favicon.ico
        pathType: Exact
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      # Next.js static assets
      - path: /_next
        pathType: Prefix
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      # Only allow sign-in, not sign-up
      - path: /auth/sign-in
        pathType: Prefix
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      - path: /auth/error
        pathType: Prefix
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      - path: /auth/verify-request
        pathType: Prefix
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      - path: /sign-in
        pathType: Prefix
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      - path: /organization
        pathType: Prefix
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
---
# Langfuse API routes ingress (no rewriting for API calls)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: langfuse-api-ingress
  namespace: devops-tools
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/priority: "200"
    nginx.ingress.kubernetes.io/rewrite-target: /api/$1
    nginx.ingress.kubernetes.io/use-regex: "true"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - DOMAIN_PLACEHOLDER
      secretName: DOMAIN_SECRET_PLACEHOLDER
  rules:
  - host: DOMAIN_PLACEHOLDER
    http:
      paths:
      # API routes under /langfuse - rewrite to remove /langfuse prefix
      - path: /langfuse/api/(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
---
# Langfuse static assets ingress (no rewriting)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: langfuse-assets-ingress
  namespace: devops-tools
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/priority: "150"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/use-regex: "true"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - DOMAIN_PLACEHOLDER
      secretName: DOMAIN_SECRET_PLACEHOLDER
  rules:
  - host: DOMAIN_PLACEHOLDER
    http:
      paths:
      # Static assets under /langfuse
      - path: /langfuse/(_next/.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      - path: /langfuse/(icon\.svg)
        pathType: ImplementationSpecific
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
      - path: /langfuse/(favicon\.ico)
        pathType: ImplementationSpecific
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000
---
# Main Langfuse application ingress (with rewriting)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: langfuse-app-ingress
  namespace: devops-tools
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/priority: "100"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/use-regex: "true"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - DOMAIN_PLACEHOLDER
      secretName: DOMAIN_SECRET_PLACEHOLDER
  rules:
  - host: DOMAIN_PLACEHOLDER
    http:
      paths:
      # Langfuse application main path - rewrite /langfuse to / and /langfuse/xxx to /xxx
      - path: /langfuse/?(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: langfuse-web
            port:
              number: 3000