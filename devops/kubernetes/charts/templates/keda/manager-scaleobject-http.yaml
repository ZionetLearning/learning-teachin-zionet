{{- if .Values.keda.enabled }}
apiVersion: http.keda.sh/v1alpha1
kind: HTTPScaledObject
metadata:
  name: manager-http-scaledobject
  namespace: {{ include "app.namespace" . }}
spec:
  hosts:
  - teachin.westeurope.cloudapp.azure.com
  scaleTargetRef:
    name: {{ .Values.manager.name }}
    port: {{ .Values.manager.ports.container }}
    service: {{ .Values.manager.name }}  # Ensure this matches the actual service name
  replicas:
    min: 0               # Scale to zero when no traffic (keep KEDA purpose)
    max: 10               # Maximum replicas
  pollingInterval: 1     # Very responsive scaling (check every 1 second)
  scaledownPeriod: 300   # 5 minutes idle before scale down
  targetPendingRequests: 1  # Scale up on any pending request
  scaleUpCooldownPeriod: 2   # Very fast scale up (2 seconds)
  scaleDownCooldownPeriod: 30
  # Optimize timeout configurations for scale-to-zero
  responseTimeout: 300   # Wait up to 5 minutes for cold start response (increased)
  keepAliveTimeout: 90   # Keep connections alive longer
  targetPendingRequestsThreshold: 300  # Queue even more requests during startup
  # Add connection pooling for better performance
  connectionTimeout: 30  # Faster connection establishment
  gracefulShutdownTimeout: 60  # Graceful shutdown for better reliability
  # Advanced configuration for better scale-to-zero behavior
  scalingModifiers:
    target: 1
    activationThreshold: 1      # Start scaling on first request
    formula: "ceiling(keda_http_pending_requests / 1)"
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 0    # Scale up immediately
          selectPolicy: Max
          policies:
          - type: Percent
            value: 1000                    # Allow massive scale up
            periodSeconds: 1
        scaleDown:
          stabilizationWindowSeconds: 300  # Wait 5 minutes before scale down
          selectPolicy: Min
          policies:
          - type: Percent
            value: 100
            periodSeconds: 60
{{- end }}