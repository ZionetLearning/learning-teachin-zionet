name: Spot Node Optimization

on:
  workflow_dispatch:  # Allow manual triggering
    inputs:
      environment:
        description: "Select environment (GitHub Environment)"
        required: true
        default: "Development"
        type: choice
        options: [Development, Production]

env:
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  spot-optimization:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || github.event.inputs.environment }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
      - name: Get AKS credentials
        run: |
            echo "AKS_RG=dev-zionet-learning-2025" >> $GITHUB_ENV
            echo "AKS_NAME=aks-cluster-dev" >> $GITHUB_ENV
            

      - name: Get AKS credentials
        run: az aks get-credentials --resource-group $AKS_RG --name $AKS_NAME --overwrite-existing
        
      - name: Restart all namespaces if spot nodes exist
        run: |
            # Check spot nodes - just check if any exist
            echo "Checking if spot nodes exist..."
            SPOT_NODES=$(kubectl get nodes -l node-type=spot --no-headers | awk '{print $1}' || echo "")
            
            if [ -z "$SPOT_NODES" ]; then
            echo "No spot nodes exist - skipping optimization"
            exit 0
            fi
            
            echo "Spot nodes exist: $SPOT_NODES"
            
            # Get all namespaces except excluded ones
            ALL_NAMESPACES=$(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | grep -v -E '^(dev|devops-ingress-nginx|external-secrets|cert-manager|dapr-system|kube-public|kube-node-lease|kube-system|default|db-proxy)$')
            
            echo "Found namespaces to restart: $ALL_NAMESPACES"
            
            # Restart all deployments in each namespace
            for namespace in $ALL_NAMESPACES; do
            echo ""
            echo "Processing namespace: $namespace"
            
            DEPLOYMENTS=$(kubectl get deployments -n "$namespace" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
            
            if [ -n "$DEPLOYMENTS" ]; then
                echo "Restarting deployments: $DEPLOYMENTS"
                
                for deployment in $DEPLOYMENTS; do
                echo "Restarting $deployment"
                kubectl rollout restart deployment/"$deployment" -n "$namespace" 2>/dev/null || echo "Failed to restart $deployment"
                done
            else
                echo "No deployments found in $namespace"
            fi
            
            sleep 5  # Brief pause between namespaces
            done
            
            echo "All deployments restarted!"