name: Backend - CI For PRs

concurrency:
  group: backend-ci-test
  cancel-in-progress: false
  
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  pull_request:
    paths:
      - 'backend/**'

jobs:
  acquire-test-namespace:
    runs-on: ubuntu-latest
    environment: testing
    steps:
      - name: Acquire test namespace lock
        run: echo "Test namespace acquired"
  deploy-under-test:
    needs: acquire-test-namespace
    uses: ./.github/workflows/update-images.yaml
    permissions:
      id-token: write
      contents: read
      issues: write
    with:
      environment: Development
      # deploy into the test namespace
      environment_name: test
      # leave empty to build all services (accessor/manager/engine).
      # or set like: "manager,engine"
    secrets: inherit

  run-integration-tests:
    needs: deploy-under-test
    uses: ./.github/workflows/integration-tests.yml
    with:
      api_stage: 'test'
    permissions:
      contents: read
    secrets: inherit

  teardown-services:
    needs: run-integration-tests
    if: ${{ always() }}
    runs-on: ubuntu-latest
    environment: Development
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Login to AKS using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get AKS credentials
        uses: azure/aks-set-context@v4
        with:
          resource-group: dev-zionet-learning-2025
          cluster-name: aks-cluster-dev

      - name: Scale down all services
        run: |
          echo "[*] Scaling down manager, accessor, engine..."
          kubectl scale deployment manager -n test --replicas=0
          kubectl scale deployment accessor -n test --replicas=0
          kubectl scale deployment engine -n test --replicas=0