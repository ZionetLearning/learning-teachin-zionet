name: Backend - CI For PRs

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  pull_request:
    paths:
      - 'backend/**'

jobs:
  deploy-under-test:
    uses: ./.github/workflows/update-images.yaml
    permissions:
      id-token: write
      contents: read
      issues: write
    with:
      environment: Development
      # deploy into the test namespace
      environment_name: test
      # leave empty to build all services (accessor/manager/engine).
      # or set like: "manager,engine"
      use_keda: false
    secrets: inherit

  run-integration-tests:
    needs: deploy-under-test
    uses: ./.github/workflows/integration-tests.yml
    with:
      api_stage: 'test'
    permissions:
      contents: read
    secrets: inherit

  teardown-services:
    needs: run-integration-tests
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Login to AKS using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get AKS credentials
        uses: azure/aks-set-context@v4
        with:
          resource-group: dev-zionet-learning-2025
          cluster-name: aks-cluster-dev

      - name: Scale down all services
        run: |
          echo "[*] Scaling down manager, accessor, engine..."
          kubectl scale deployment manager -n test --replicas=0
          kubectl scale deployment accessor -n test --replicas=0
          kubectl scale deployment engine -n test --replicas=0

  # this needs to run even if the tests fail
  # clear-db:
  #   needs: run-integration-tests
  #   if: ${{ always() }}
  #   uses: ./.github/workflows/clear-postgres.yml
  #   permissions:
  #     id-token: write
  #     contents: read
  #   with:
  #     mode: 'truncate'
  #     pg_database: 'appdb-test'
  #     dry_run: 'false'
  #     verify_ssl: 'true'
  #   secrets:
  #     POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
  #     POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
  #     AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  #     AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  #     AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
