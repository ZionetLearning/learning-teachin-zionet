name: Lock / Unlock Featest (via Issue)

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Lock or Unlock the featest environment"
        required: true
        type: choice
        options: [lock, unlock]

permissions:
  issues: write   # ğŸ‘ˆ ×—×©×•×‘ â€“ ×”×¨×©××” ×œ× ×™×”×•×œ issues

jobs:
  manage-lock:
    runs-on: ubuntu-latest
    steps:
      - name: Manage lock state
        run: |
          ACTION=${{ github.event.inputs.action }}
          USER=${GITHUB_ACTOR}

          if [ "$ACTION" = "lock" ]; then
            echo "ğŸ”’ Locking featest by $USER"

            # Check if already locked
            ISSUE=$(gh issue list \
              --search "LOCK: featest" \
              --state open \
              --json number \
              --jq '.[0].number' || true)

            if [ -n "$ISSUE" ]; then
              echo "âŒ featest is already locked (issue #$ISSUE)"
              exit 1
            fi

            gh issue create \
              --title "LOCK: featest" \
              --body "locked_by=$USER\nlocked_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "lock"

            echo "âœ… featest is now locked by $USER"

          elif [ "$ACTION" = "unlock" ]; then
            echo "ğŸ”“ Unlocking featest by $USER"

            ISSUE=$(gh issue list \
              --search "LOCK: featest" \
              --state open \
              --json number \
              --jq '.[0].number' || true)

            if [ -z "$ISSUE" ]; then
              echo "â„¹ï¸ featest is not locked"
              exit 0
            fi

            gh issue close "$ISSUE" -c "Unlocked by $USER"
            echo "âœ… featest is now unlocked by $USER"
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}