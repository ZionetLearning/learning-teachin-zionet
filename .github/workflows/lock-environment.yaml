name: Lock / Unlock Featest

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Lock or Unlock the featest environment"
        required: true
        type: choice
        options: [lock, unlock]

permissions:   # ðŸ‘ˆ ×—×©×•×‘ ×©×–×” ×™×”×™×” ×‘×¨×ž×ª ×”Ö¾workflow
  contents: write
  actions: write

jobs:
  manage-lock:
    runs-on: ubuntu-latest
    steps:
      - name: Manage lock state
        run: |
          ACTION=${{ github.event.inputs.action }}
          USER=${GITHUB_ACTOR}

          if [ "$ACTION" = "lock" ]; then
            echo "ðŸ”’ Locking featest by $USER"

            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/actions/variables/FEATEST_LOCKED \
              -f value="true"

            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/actions/variables/FEATEST_LOCKED_BY \
              -f value="$USER"

            echo "âœ… featest is now locked by $USER"

          elif [ "$ACTION" = "unlock" ]; then
            echo "ðŸ”“ Unlocking featest by $USER"

            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/actions/variables/FEATEST_LOCKED \
              -f value="false"

            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/actions/variables/FEATEST_LOCKED_BY \
              -f value="noone"

            echo "âœ… featest is now unlocked by $USER"
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}
