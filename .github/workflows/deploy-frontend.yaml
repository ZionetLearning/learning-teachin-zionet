name: Frontend- Deploy Apps to Azure Static Web Apps
run-name: >
  ðŸš€ Deploy Frontend Apps (student, teacher, admin) to environment: ${{
    inputs.environment_name || github.event.inputs.environment_name || 'dev'
  }} | GitHub Environment: ${{ inputs.environment || github.event.inputs.environment || 'Development'}}
   
permissions:
   contents: read

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
    paths:
      - 'frontend/**'
  push:
    branches: [main]
    paths: ['frontend/**']    
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment (GitHub Environment)'
        required: true
        default: 'Development'
        type: choice
        options: [Development, Production]
      environment_name:
        description: 'lowercase letters & digits only (env identifier) where the application is deployed'
        required: true
        type: string
      run_only_tests:
        description: 'Run only frontend tests'
        required: false
        default: true
        type: boolean
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      environment_name:
        required: true
        type: string
      app_insights_connection_string:
        required: false
        type: string
      deployment_token:
        required: false
        type: string
      run_only_tests:
        required: false
        type: boolean
        default: false
    secrets:
      AZURE_STATIC_WEB_APPS_API_TOKEN:
        required: false

concurrency:
  group: deploy-frontend-apps-${{ inputs.environment_name || github.event.inputs.environment_name || 'dev' }}
  cancel-in-progress: false

env:
  # Secrets and external APIs (environment-agnostic)
  VITE_AZURE_SPEECH_KEY: ${{ secrets.VITE_AZURE_SPEECH_KEY }}
  VITE_OPENWEATHERMAP_API_KEY: ${{ secrets.VITE_OPENWEATHERMAP_API_KEY }}
  VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
  
  # Backend URLs and other config will be loaded dynamically from env-cloud.js

jobs:
  frontend-build-deploy:
    uses: ./.github/workflows/frontend-build-deploy.yaml
    with:
      environment: ${{ inputs.environment || 'Development' }}
      environment_name: ${{ inputs.environment_name || github.event.inputs.environment_name || 'dev' }}
      run_only_tests: ${{ inputs.run_only_tests || false }}
    secrets: inherit