name: AKS - Scheduled Start/Stop

on:
  schedule:
    # 8:00 Israel time = 5:00 UTC (START: Sunday-Thursday)
    - cron: '0 5 * * 0-4'
    # 19:30 Israel time = 16:30 UTC (STOP: Sunday-Saturday)
    - cron: '30 16 * * 0-6'
  workflow_dispatch:  # Allow manual testing

jobs:
  scheduled-operation:
    runs-on: ubuntu-latest
    environment: Development
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Determine action based on schedule
        id: determine_action
        run: |
          # Get current time in Israel timezone
          ISRAEL_TIME=$(TZ='Asia/Jerusalem' date '+%Y-%m-%d %H:%M:%S %Z')
          ISRAEL_HOUR=$(TZ='Asia/Jerusalem' date '+%H')
          DAY_OF_WEEK=$(TZ='Asia/Jerusalem' date '+%u')  # 1=Monday, 7=Sunday
          DAY_NAME=$(TZ='Asia/Jerusalem' date '+%A')
          
          echo "Current Israel time: $ISRAEL_TIME"
          echo "Day of week: $DAY_OF_WEEK ($DAY_NAME)"
          
          # Determine if this is morning or evening schedule based on hour
          if [[ $ISRAEL_HOUR -ge 5 && $ISRAEL_HOUR -le 10 ]]; then
            # Morning schedule (around 8:30 AM Israel time)
            echo "Morning schedule detected - START action"
            echo "action=START" >> $GITHUB_OUTPUT
            echo "schedule_type=morning" >> $GITHUB_OUTPUT
          elif [[ $ISRAEL_HOUR -ge 16 && $ISRAEL_HOUR -le 22 ]]; then
            # Evening schedule (around 7:30 PM Israel time)  
            echo "Evening schedule detected - STOP action"
            echo "action=STOP" >> $GITHUB_OUTPUT
            echo "schedule_type=evening" >> $GITHUB_OUTPUT
          else
            echo "Unknown schedule time - defaulting to manual trigger"
            echo "action=MANUAL" >> $GITHUB_OUTPUT
            echo "schedule_type=manual" >> $GITHUB_OUTPUT
          fi

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set up variables
        run: |
          echo "AKS_RG=dev-zionet-learning-2025" >> $GITHUB_ENV
          echo "AKS_NAME=aks-cluster-dev" >> $GITHUB_ENV

      - name: Check current cluster status
        run: |
          STATUS=$(az aks show --resource-group $AKS_RG --name $AKS_NAME --query "powerState.code" -o tsv)
          echo "Current AKS cluster status: $STATUS"
          
          ACTION="${{ steps.determine_action.outputs.action }}"
          
          if [[ "$ACTION" == "START" && "$STATUS" == "Running" ]]; then
            echo "‚ö†Ô∏è Cluster is already running"
          elif [[ "$ACTION" == "STOP" && "$STATUS" == "Stopped" ]]; then
            echo "‚ö†Ô∏è Cluster is already stopped"
          fi

      - name: Start AKS cluster (Morning Schedule)
        if: steps.determine_action.outputs.action == 'START'
        run: |
          echo "üöÄ Starting AKS cluster: $AKS_NAME (morning schedule - 8:30 AM Israel time)"
          START_TIME=$(date +%s)
          az aks start --resource-group $AKS_RG --name $AKS_NAME
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "‚úÖ AKS cluster start completed in ${DURATION} seconds"

      - name: Stop AKS cluster (Evening Schedule)
        if: steps.determine_action.outputs.action == 'STOP'
        run: |
          echo "üõë Stopping AKS cluster: $AKS_NAME (evening schedule - 7:30 PM Israel time)"
          START_TIME=$(date +%s)
          az aks stop --resource-group $AKS_RG --name $AKS_NAME
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "‚úÖ AKS cluster stop completed in ${DURATION} seconds"

      - name: Wait for cluster to be ready (START only)
        if: steps.determine_action.outputs.action == 'START'
        run: |
          echo "‚è≥ Waiting for cluster to be fully ready..."
          WAIT_START=$(date +%s)
          for i in {1..30}; do
            STATUS=$(az aks show --resource-group $AKS_RG --name $AKS_NAME --query "powerState.code" -o tsv)
            if [[ "$STATUS" == "Running" ]]; then
              WAIT_END=$(date +%s)
              WAIT_DURATION=$((WAIT_END - WAIT_START))
              echo "‚úÖ Cluster is running and ready after ${WAIT_DURATION} seconds"
              break
            fi
            echo "Attempt $i: Cluster status is $STATUS, waiting 30s..."
            sleep 30
          done

      - name: Verify final status
        run: |
          FINAL_STATUS=$(az aks show --resource-group $AKS_RG --name $AKS_NAME --query "powerState.code" -o tsv)
          ACTION="${{ steps.determine_action.outputs.action }}"
          SCHEDULE_TYPE="${{ steps.determine_action.outputs.schedule_type }}"
          
          echo "üìã Schedule Summary:"
          echo "Schedule type: $SCHEDULE_TYPE"
          echo "Action performed: $ACTION"
          echo "Final cluster status: $FINAL_STATUS"
          
          if [[ "$ACTION" == "START" && "$FINAL_STATUS" == "Running" ]]; then
            echo "‚úÖ Morning startup successful - cluster ready for workday"
          elif [[ "$ACTION" == "STOP" && "$FINAL_STATUS" == "Stopped" ]]; then
            echo "‚úÖ Evening shutdown successful - saving costs overnight"
          elif [[ "$ACTION" == "MANUAL" ]]; then
            echo "‚ÑπÔ∏è Manual trigger - current status: $FINAL_STATUS"
          fi