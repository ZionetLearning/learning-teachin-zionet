name: Full CICD

run-name: >
  ðŸ”„ Full CICD | Environment: ${{ 
    github.event.inputs.environment_name || 'custom' 
  }} | GitHub Env: ${{ github.event.inputs.environment }}

on:
  # push:
  #  branches:
  #    - main
    workflow_dispatch:
      inputs:
        environment:
          description: 'Select environment (GitHub Environment)'
          required: true
          default: 'Development'
          type: choice
          options: [Development, Production]
        environment_name:
          description: 'Enter custom prefix (lowercase letters & digits only). This will be used as the Kubernetes namespace and environment identifier.'
          required: true
          type: string
        list_services_names:
          description: 'Optional comma-separated list of services to build (e.g., accessor,manager). Leave empty for all.'
          required: false
          type: string
          default: ''
        use_keda:
          description: 'Enable KEDA setup workflow'
          type: boolean
          required: false
          default: false
          
jobs:
  build-and-push-images:
    uses: ./.github/workflows/build-and-push-images.yaml
    permissions:
      id-token: write
      contents: read
    with:
      environment: ${{ github.event.inputs.environment }}
      environment_name: ${{ github.event.inputs.environment_name }}
      list_services_names: ${{ github.event.inputs.list_services_names }}
    secrets: inherit
 
  terraform-apply:
    uses: ./.github/workflows/terraform-apply.yaml
    permissions:
      id-token: write
      contents: read
    with:
      environment_name: ${{ github.event.inputs.environment_name }}
      environment: ${{ github.event.inputs.environment }}
    secrets: inherit
 
  aks-kubectl-apply:
    if: ${{ github.event.inputs.environment_name == 'dev' || github.event.inputs.environment_name == 'prod' }}
    needs: [build-and-push-images, terraform-apply]
    uses: ./.github/workflows/aks-kubectl-apply.yaml
    permissions:
      id-token: write
      contents: read
    with:
      environment_name: ${{ github.event.inputs.environment_name }}
      environment: ${{ github.event.inputs.environment }}
    secrets: inherit
   
  helmcharts-setup:
    needs: [build-and-push-images, terraform-apply, aks-kubectl-apply]
    if: ${{ always() && contains(fromJson('["success","skipped"]'), needs.aks-kubectl-apply.result) }}
    uses: ./.github/workflows/aks-helmcharts.yaml
    permissions:
      id-token: write
      contents: read
    with:
      environment_name: ${{ github.event.inputs.environment_name }}
      environment: ${{ github.event.inputs.environment }}
      image_tag: ${{ needs.build-and-push-images.outputs.image_tag }}
      skip_infra_steps: false
      use_keda: ${{ github.event.inputs.use_keda }}
    secrets: inherit

  keda-setup:
    if: ${{ github.event.inputs.use_keda }}
    needs: [helmcharts-setup]
    uses: ./.github/workflows/aks-keda.yaml
    permissions:
      id-token: write
      contents: read
    with:
      environment_name: ${{ github.event.inputs.environment_name }}
      environment: ${{ github.event.inputs.environment }}
      skip_infra_steps: true
      use_chart: false

    secrets: inherit
 
  deploy-frontend:
    needs: [terraform-apply]
    uses: ./.github/workflows/deploy-frontend.yaml
    permissions:
      id-token: write
      contents: read
    with:
      environment: ${{ github.event.inputs.environment }}
      environment_name: ${{ github.event.inputs.environment_name }}
      deployment_token: ${{ needs.terraform-apply.outputs.static_web_app_api_keys }}
      app_insights_connection_string: ${{ needs.terraform-apply.outputs.application_insights_connection_strings }}
    secrets: inherit
 
 