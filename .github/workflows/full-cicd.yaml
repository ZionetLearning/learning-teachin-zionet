name: Full CICD

run-name: >
  ðŸ”„ Full CICD | Environment: ${{ 
    github.event.inputs.environment_name || 'custom' 
  }} | GitHub Env: ${{ github.event.inputs.environment }}

permissions:
  id-token: write
  contents: read

on:
    workflow_dispatch:
      inputs:
        environment:
          description: 'Select environment (GitHub Environment)'
          required: true
          default: 'Development'
          type: choice
          options: [Development, Production]
        environment_name:
          description: 'Enter custom prefix (lowercase letters & digits only). This will be used as the Kubernetes namespace and environment identifier.'
          required: true
          type: string
        proxy_enabled:
          description: 'Enable the proxy. Set to false to disable proxy and deploy services without it.'
          required: false
          default: true
          type: boolean
        frontend_apps:
          description: 'Select frontend deployment option'
          required: false
          type: choice
          default: 'all'
          options: 
            - 'all'
            - 'none'
          
jobs:
  validate-authorization:
    uses: ./.github/workflows/validate-confirmation.yaml
    secrets: inherit

  build-and-push-images:
    needs: validate-authorization
    uses: ./.github/workflows/build-and-push-images.yaml
    with:
      environment: ${{ github.event.inputs.environment }}
      environment_name: ${{ github.event.inputs.environment_name }}
    secrets: inherit
 
  terraform-apply:
    needs: [validate-authorization]
    uses: ./.github/workflows/terraform-apply.yaml
    with:
      environment_name: ${{ github.event.inputs.environment_name }}
      environment: ${{ github.event.inputs.environment }}
      frontend_apps: ${{ github.event.inputs.frontend_apps }}
    secrets: inherit
 
  aks-kubectl-apply:
    if: ${{ github.event.inputs.environment_name == 'dev' || github.event.inputs.environment_name == 'prod' }}
    needs: [build-and-push-images, terraform-apply]
    uses: ./.github/workflows/aks-kubectl-apply.yaml
    with:
      environment: ${{ github.event.inputs.environment }}
    secrets: inherit
   
  helmcharts-setup:
    needs: [build-and-push-images, terraform-apply, aks-kubectl-apply]
    if: ${{ always() && needs.terraform-apply.result == 'success' && contains(fromJson('["success","skipped"]'), needs.aks-kubectl-apply.result) }}
    uses: ./.github/workflows/aks-helmcharts.yaml
    with:
      environment_name: ${{ github.event.inputs.environment_name }}
      environment: ${{ github.event.inputs.environment }}
      image_tag: ${{ needs.build-and-push-images.outputs.image_tag }}
      proxy_enabled: ${{ github.event.inputs.proxy_enabled || true }}
      skip_infra_steps: false
    secrets: inherit
 
  deploy-frontend:
    if: ${{ github.event.inputs.environment_name == 'dev' || github.event.inputs.frontend_apps == 'all' }}
    needs: [terraform-apply]
    uses: ./.github/workflows/frontend-pipeline.yaml
    with:
      environment: ${{ github.event.inputs.environment }}
      environment_name: ${{ github.event.inputs.environment_name }}
    secrets: inherit
 
 